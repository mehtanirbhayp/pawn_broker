<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS and Sons - Pawn Broker System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .header .datetime {
            font-size: 1em;
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: inline-block;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .nav {
            background: #34495e;
            padding: 0;
        }
        
        .nav ul {
            list-style: none;
            display: flex;
            margin: 0;
        }
        
        .nav li {
            flex: 1;
        }
        
        .nav a {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            text-align: center;
            transition: background 0.3s;
            border-right: 1px solid #2c3e50;
        }
        
        .nav a:hover, .nav a.active {
            background: #2c3e50;
        }
        
        .nav li:last-child a {
            border-right: none;
        }
        
        .content {
            padding: 30px;
            min-height: 500px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status.active {
            background: #d4edda;
            color: #155724;
        }
        
        .status.released {
            background: #cce5ff;
            color: #004085;
        }
        
        .status.unredeemed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            margin: auto;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 10px 20px;
            border-top: 2px solid #eee;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 2px solid #eee;
            background: #f8f9fa;
            border-radius: 15px 15px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }
        
        .close-modal {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .loan-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .detail-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .detail-section h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-item {
            margin-bottom: 8px;
        }
        
        .detail-item strong {
            color: #555;
            display: inline-block;
            min-width: 120px;
        }
        
        .detail-item span {
            color: #333;
        }
        
        .modal-footer h3 {
            margin-bottom: 8px;
            color: #2c3e50;
            text-align: center;
            font-size: 0.95em;
        }
        
        .modal-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .modal-buttons .btn {
            min-width: 120px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav ul {
                flex-direction: column;
            }
            
            .nav a {
                border-right: none;
                border-bottom: 1px solid #2c3e50;
            }
            
            .nav li:last-child a {
                border-bottom: none;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .modal-buttons .btn {
                width: 100%;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .modal-footer {
                padding: 15px 20px;
            }
        }

        .hidden {
            display: none !important;
        }

        .login-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .login-overlay.active {
            display: flex;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-card h2 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .login-card p {
            margin-bottom: 30px;
            color: #7f8c8d;
        }

        .login-card .form-group {
            text-align: left;
        }

        .login-card button {
            width: 100%;
        }

        .logout-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .logout-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Hamburger Menu Styles */
        .hamburger-menu {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 30px;
            height: 30px;
            justify-content: center;
            align-items: center;
        }

        .hamburger-menu:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .hamburger-menu span {
            display: block;
            width: 20px;
            height: 2px;
            background: white;
            transition: all 0.3s;
        }

        .hamburger-menu.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger-menu.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Settings Menu */
        .settings-menu {
            position: fixed;
            top: 60px;
            left: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            min-width: 300px;
            max-width: 500px;
            z-index: 99;
            display: none;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .settings-menu.active {
            display: flex;
            flex-direction: column;
        }

        .settings-menu-header {
            padding: 15px 20px;
            border-bottom: 2px solid #667eea;
            background: #f8f9fa;
        }

        .settings-menu-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-menu-header .back-button {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            display: none;
            align-items: center;
            gap: 5px;
        }

        .settings-menu-header .back-button.active {
            display: flex;
        }

        .settings-menu-header .back-button:hover {
            color: #764ba2;
        }

        .settings-menu-list {
            display: flex;
            flex-direction: column;
            padding: 10px 0;
        }

        .settings-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
            border-left: 3px solid transparent;
        }

        .settings-menu-item:hover {
            background: #f8f9fa;
            border-left-color: #667eea;
        }

        .settings-menu-item .icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }

        .settings-menu-item .label {
            flex: 1;
            font-weight: 500;
        }

        .settings-menu-item .arrow {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .settings-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-height: 500px;
        }

        .settings-content.active {
            display: block;
        }

        .settings-item {
            margin-bottom: 15px;
        }

        .settings-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .settings-item input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .settings-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .settings-actions .btn {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        /* New Loan Form Redesign */
        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .form-section-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .form-section-content {
            display: grid;
            gap: 12px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        .required-marker {
            color: #e74c3c;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
        }

        .form-actions .btn {
            min-width: 150px;
            padding: 12px 25px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 6px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }

        .form-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }

        .form-actions .btn-reset {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .form-actions .btn-submit {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .form-hint {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 3px;
            font-style: italic;
        }

        .section-title {
            font-size: 1.6em;
            color: #2c3e50;
            margin-bottom: 8px;
            font-weight: 300;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-subtitle {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 20px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pagination button,
        .pagination span {
            min-width: 36px;
            height: 36px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-number.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            font-weight: 600;
        }

        .pagination .ellipsis {
            cursor: default;
            border: none;
            background: transparent;
        }

        @media (max-width: 768px) {
            .form-section {
                padding: 20px;
            }

            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <h2>Welcome Back</h2>
            <p>Please sign in to continue</p>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">User ID</label>
                    <input type="text" id="loginUsername" required placeholder="Enter your user ID">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>
                <button type="submit" class="btn">Login</button>
                <div id="loginError" class="alert alert-error hidden" style="margin-top: 15px;"></div>
            </form>
        </div>
    </div>
    <div class="container hidden" id="appContainer">
        <div class="header">
            <button id="hamburgerMenu" class="hamburger-menu" onclick="toggleSettingsMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <button id="logoutButton" class="logout-button">Logout</button>
            <h1>MS and Sons</h1>
            <p>Digital Pawn Broker Management System</p>
            <div class="datetime" id="datetime"></div>
        </div>
        
        <div id="settingsMenu" class="settings-menu">
            <div class="settings-menu-header">
                <button class="back-button" onclick="showSettingsMenu()">
                    <span>‚Üê</span>
                    <span>Back</span>
                </button>
                <h3>‚öôÔ∏è Settings</h3>
            </div>
            <div id="settingsMenuList" class="settings-menu-list">
                <div class="settings-menu-item" onclick="showSettingsContent('prefixes')">
                    <span class="icon">üî§</span>
                    <span class="label">Serial Number Prefixes</span>
                    <span class="arrow">‚Üí</span>
                </div>
                <div class="settings-menu-item" onclick="showSettingsContent('columns')">
                    <span class="icon">üìä</span>
                    <span class="label">Table Columns</span>
                    <span class="arrow">‚Üí</span>
                </div>
                <!-- Add more menu items here in the future -->
            </div>
            <div id="settingsContent" class="settings-content">
                <div class="loading">Loading settings...</div>
            </div>
        </div>
        
        <nav class="nav">
            <ul>
                <li><a href="#" onclick="showSection('dashboard')" class="active">Dashboard</a></li>
                <li><a href="#" onclick="showSection('new-loan')">New Loan</a></li>
                <li><a href="#" onclick="showSection('loans')">View Loans</a></li>
                <li><a href="#" onclick="showSection('mailing-label')">Mailing Label</a></li>
                <li><a href="#" onclick="showSection('master-sheet')">Master Sheet</a></li>
            </ul>
        </nav>
        
        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <h2>Dashboard</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">Loading statistics...</div>
                </div>
                
                <h3>Recent Loans</h3>
                <div id="recentLoans">
                    <div class="loading">Loading recent loans...</div>
                </div>
            </div>
            
            <!-- New Loan Section -->
            <div id="new-loan" class="section">
                <h2 class="section-title">‚ú® Create New Loan</h2>
                <p class="section-subtitle">Fill in the details below to create a new loan entry</p>
                
                <form id="loanForm" autocomplete="off" novalidate>
                    <!-- Company & Item Information Section -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <div class="form-section-icon">üè¢</div>
                            <h3>Company & Item Information</h3>
                        </div>
                        <div class="form-section-content">
                            <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label for="company">
                                        Company
                                        <span class="required-marker">*</span>
                                    </label>
                                    <select id="company" required>
                                        <option value="">Select Company</option>
                                    </select>
                                    <div class="form-hint">Choose the company issuing this loan</div>
                                </div>
                                <div class="form-group">
                                    <label for="itemType">
                                        Item Type
                                        <span class="required-marker">*</span>
                                    </label>
                                    <select id="itemType" required>
                                        <option value="">Select Type</option>
                                        <option value="gold">Gold</option>
                                        <option value="silver">Silver</option>
                                    </select>
                                    <div class="form-hint">Select gold or silver</div>
                                </div>
                                <div class="form-group">
                                    <label for="serialNumber">
                                        Serial Number
                                        <span class="required-marker">*</span>
                                    </label>
                                    <input type="text" id="serialNumber" required placeholder="Enter serial number issued by company" autocomplete="new-password">
                                    <div class="form-hint">Unique serial number assigned by the company</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information Section -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <div class="form-section-icon">üë§</div>
                            <h3>Customer Information</h3>
                        </div>
                        <div class="form-section-content">
                            <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label for="customerName">
                                        Customer Name
                                        <span class="required-marker">*</span>
                                    </label>
                                    <input type="text" id="customerName" required placeholder="Enter customer full name" autocomplete="new-password">
                                </div>
                                <div class="form-group">
                                    <label for="fatherName">Father/Husband Name</label>
                                    <input type="text" id="fatherName" placeholder="Enter father or husband name" autocomplete="new-password">
                                </div>
                                <div class="form-group">
                                    <label for="cellNumber">Cell Number</label>
                                    <input type="tel" id="cellNumber" placeholder="Enter contact number" autocomplete="new-password">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="address">
                                        Address
                                        <span class="required-marker">*</span>
                                    </label>
                                    <textarea id="address" rows="2" required placeholder="Enter complete address" autocomplete="new-password"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="aadharNumber">Aadhar Number</label>
                                    <input type="text" id="aadharNumber" placeholder="Enter Aadhar number" autocomplete="new-password" maxlength="12" pattern="[0-9]{12}">
                                    <div class="form-hint">12-digit Aadhar number (optional)</div>
                                </div>
                            </div>
                            <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label for="occupation">Occupation</label>
                                    <input type="text" id="occupation" placeholder="Enter occupation" autocomplete="new-password">
                                </div>
                                <div class="form-group">
                                    <label for="post">Post</label>
                                    <input type="text" id="post" placeholder="Enter post" autocomplete="new-password">
                                </div>
                                <div class="form-group">
                                    <label for="pinCode">Pin Code</label>
                                    <input type="text" id="pinCode" placeholder="Enter pin code" autocomplete="new-password">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loan Details Section -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <div class="form-section-icon">üí∞</div>
                            <h3>Loan Details</h3>
                        </div>
                        <div class="form-section-content">
                            <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label for="loanAmount">
                                        Loan Amount (‚Çπ)
                                        <span class="required-marker">*</span>
                                    </label>
                                    <input type="number" id="loanAmount" step="0.01" required placeholder="0.00" autocomplete="off">
                                    <div class="form-hint">Enter the loan amount in rupees</div>
                                </div>
                                <div class="form-group">
                                    <label for="itemWeight">
                                        Item Weight (grams)
                                        <span class="required-marker">*</span>
                                    </label>
                                    <input type="number" id="itemWeight" step="0.001" required placeholder="0.000" autocomplete="off">
                                    <div class="form-hint">Weight of the pledged item in grams</div>
                                </div>
                                <div class="form-group">
                                    <label for="loanDate">Loan Date</label>
                                    <input type="date" id="loanDate" autocomplete="off">
                                    <div class="form-hint">Date when the loan is issued</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="itemDescription">
                                    Item Description
                                    <span class="required-marker">*</span>
                                </label>
                                <textarea id="itemDescription" rows="2" required placeholder="Describe the item being pledged (e.g., gold chain, silver coins, etc.)" autocomplete="new-password"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="reset" class="btn btn-reset">Reset Form</button>
                        <button type="submit" class="btn btn-submit">Create Loan</button>
                    </div>
                </form>
            </div>
            
            <!-- Loans Section -->
            <div id="loans" class="section">
                <h2>View Loans</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="filterCompany">Filter by Company</label>
                        <select id="filterCompany">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterStatus">Filter by Status</label>
                        <select id="filterStatus">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="released">Released</option>
                            <option value="unredeemed">Unredeemed</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="loanSearch">Search Loans</label>
                        <input type="text" id="loanSearch" placeholder="Serial number, customer name, or phone">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="button" class="btn" onclick="loadLoans()">Search</button>
                    </div>
                </div>

                <button onclick="loadLoans()" class="btn">Load Loans</button>
                
                <div id="loansTable">
                    <div class="loading">Click "Load Loans" to view data</div>
                </div>
            </div>
            
            <!-- Mailing Label Section -->
            <div id="mailing-label" class="section">
                <h2 class="section-title">üìÆ Mailing Label</h2>
                <p class="section-subtitle">Generate mailing labels for loan records</p>
                
                <div class="form-section">
                    <div class="form-section-header">
                        <div class="form-section-icon">üè¢</div>
                        <h3>Filter by Company</h3>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group">
                            <label for="mailingLabelCompany">Select Company</label>
                            <select id="mailingLabelCompany">
                                <option value="">Select Company</option>
                            </select>
                            <div class="form-hint">Select a company to generate mailing labels for all its loans</div>
                        </div>
                        <div class="form-group">
                            <label for="mailingLabelStatus">Filter by Status (Optional)</label>
                            <select id="mailingLabelStatus">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="released">Released</option>
                                <option value="unredeemed">Unredeemed</option>
                            </select>
                            <div class="form-hint">Optionally filter by loan status</div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mailingLabelStartDate">Start Date (Optional)</label>
                                <input type="date" id="mailingLabelStartDate">
                                <div class="form-hint">Filter loans from this date onwards</div>
                            </div>
                            <div class="form-group">
                                <label for="mailingLabelEndDate">End Date (Optional)</label>
                                <input type="date" id="mailingLabelEndDate">
                                <div class="form-hint">Filter loans up to this date</div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button onclick="generateMailingLabelByCompany()" class="btn btn-submit">Generate Labels by Company</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-section" style="margin-top: 20px;">
                    <div class="form-section-header">
                        <div class="form-section-icon">üîç</div>
                        <h3>Search by Loan IDs or Serial Numbers</h3>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group">
                            <label for="mailingLabelLoanId">Loan IDs or Serial Numbers</label>
                            <textarea id="mailingLabelLoanId" rows="4" placeholder="Enter Loan IDs or Serial Numbers (one per line or comma-separated)"></textarea>
                            <div class="form-hint">Enter multiple loan IDs or serial numbers, one per line or separated by commas</div>
                        </div>
                        <div class="form-actions">
                            <button onclick="generateMailingLabel()" class="btn btn-submit">Generate Mailing Labels</button>
                        </div>
                    </div>
                </div>
                
                <div id="mailingLabelResult"></div>
            </div>
            
            <!-- Master Sheet Section -->
            <div id="master-sheet" class="section">
                <h2>Master Sheet</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="msCompany">Company</label>
                        <select id="msCompany">
                            <option value="">Select Company</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="msStatus">Status</label>
                        <select id="msStatus">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="released">Released</option>
                            <option value="unredeemed">Unredeemed</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                
                <button onclick="loadMasterSheet()" class="btn">Load Master Sheet</button>
                <button onclick="exportMasterSheet()" class="btn btn-success">Export to Excel</button>
                
                <div id="masterSheetResult"></div>
            </div>
        </div>
    </div>

    <!-- Loan Details Modal -->
    <div id="loanDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Loan Details</h2>
                <span class="close-modal" onclick="closeLoanDetails()">&times;</span>
            </div>
            <div class="modal-body" id="loanDetailsContent">
                <div class="loading">Loading loan details...</div>
            </div>
            <div class="modal-footer" id="loanDetailsFooter" style="display: none;">
                <div class="modal-buttons" id="loanDetailsButtons">
                    <!-- Buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let companies = [];
        let appInitialized = false;
        let currentLoanDetailsId = null; // Track which loan is currently shown in modal
        
        // Pagination state
        let currentPage = {
            dashboard: 1,
            loans: 1,
            masterSheet: 1
        };
        let totalPages = {
            dashboard: 1,
            loans: 1,
            masterSheet: 1
        };
        let allLoans = {
            dashboard: [],
            loans: [],
            masterSheet: []
        };

        // Helper function to format date as dd-mm-yyyy
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}-${month}-${year}`;
        }

        // Helper function to format status display name
        function formatStatus(status) {
            if (!status) return 'N/A';
            const statusLower = status.toLowerCase();
            const statusMap = {
                'active': 'Active',
                'released': 'Released',
                'unredeemed': 'Unredeemed',
                'delivered': 'Released',  // Legacy support
                'defaulted': 'Unredeemed'  // Legacy support
            };
            return statusMap[statusLower] || status.charAt(0).toUpperCase() + status.slice(1).toLowerCase();
        }

        // Pagination Component Function
        function generatePagination(pageType, currentPageNum, totalPagesNum, onPageChange) {
            if (totalPagesNum <= 1) return '';
            
            let paginationHTML = '<div class="pagination">';
            
            // First page button (<<)
            paginationHTML += `<button onclick="${onPageChange}(1)" ${currentPageNum === 1 ? 'disabled' : ''}>¬´</button>`;
            
            // Previous page button
            paginationHTML += `<button onclick="${onPageChange}(${currentPageNum - 1})" ${currentPageNum === 1 ? 'disabled' : ''}>‚Äπ</button>`;
            
            // Page numbers
            const maxVisible = 10;
            let startPage = Math.max(1, currentPageNum - 4);
            let endPage = Math.min(totalPagesNum, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            // Show first page if not in range
            if (startPage > 1) {
                paginationHTML += `<button onclick="${onPageChange}(1)" class="page-number">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="ellipsis">...</span>`;
                }
            }
            
            // Show page numbers
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPageNum) {
                    paginationHTML += `<button class="page-number active" disabled>${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="${onPageChange}(${i})" class="page-number">${i}</button>`;
                }
            }
            
            // Show last page if not in range
            if (endPage < totalPagesNum) {
                if (endPage < totalPagesNum - 1) {
                    paginationHTML += `<span class="ellipsis">...</span>`;
                }
                paginationHTML += `<button onclick="${onPageChange}(${totalPagesNum})" class="page-number">${totalPagesNum}</button>`;
            }
            
            // Next page button
            paginationHTML += `<button onclick="${onPageChange}(${currentPageNum + 1})" ${currentPageNum === totalPagesNum ? 'disabled' : ''}>‚Ä∫</button>`;
            
            // Last page button (>>)
            paginationHTML += `<button onclick="${onPageChange}(${totalPagesNum})" ${currentPageNum === totalPagesNum ? 'disabled' : ''}>¬ª</button>`;
            
            paginationHTML += '</div>';
            return paginationHTML;
        }

        // Serial Number Prefix Management
        function getSerialPrefixes() {
            const stored = localStorage.getItem('serialNumberPrefixes');
            return stored ? JSON.parse(stored) : {};
        }

        function saveSerialPrefixes(prefixes) {
            localStorage.setItem('serialNumberPrefixes', JSON.stringify(prefixes));
        }

        function getSerialPrefixForCompany(companyId, itemType) {
            const prefixes = getSerialPrefixes();
            if (prefixes[companyId]) {
                if (itemType && prefixes[companyId][itemType]) {
                    return prefixes[companyId][itemType];
                }
                // Fallback to old format for backward compatibility
                if (typeof prefixes[companyId] === 'string') {
                    return prefixes[companyId];
                }
            }
            return '';
        }

        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            const hamburger = document.getElementById('hamburgerMenu');
            
            if (menu.classList.contains('active')) {
                menu.classList.remove('active');
                hamburger.classList.remove('active');
                showSettingsMenu(); // Reset to menu list when closing
            } else {
                menu.classList.add('active');
                hamburger.classList.add('active');
                showSettingsMenu(); // Show menu list
            }
        }

        function showSettingsMenu() {
            const menuList = document.getElementById('settingsMenuList');
            const settingsContent = document.getElementById('settingsContent');
            const backButton = document.querySelector('.back-button');
            
            if (menuList) menuList.style.display = 'flex';
            if (settingsContent) settingsContent.classList.remove('active');
            if (backButton) backButton.classList.remove('active');
        }

        function showSettingsContent(contentType) {
            const menuList = document.getElementById('settingsMenuList');
            const settingsContent = document.getElementById('settingsContent');
            const backButton = document.querySelector('.back-button');
            
            if (menuList) menuList.style.display = 'none';
            if (settingsContent) settingsContent.classList.add('active');
            if (backButton) backButton.classList.add('active');
            
            if (contentType === 'prefixes') {
                loadPrefixSettings();
            } else if (contentType === 'columns') {
                loadColumnSettings();
            }
            // Add more content types here in the future
        }
        
        // Column Settings Management - Advanced Customization
        // All available loan data fields
        const availableLoanFields = {
            serial_number: { label: 'Serial Number', getValue: (loan) => {
                // Try multiple possible field names
                const value = loan.serial_number || loan.serialNumber || loan['serial_number'] || loan['serialNumber'];
                if (value !== undefined && value !== null && value !== '') {
                    return String(value);
                }
                return 'N/A';
            }},
            customer_name: { label: 'Customer Name', getValue: (loan) => loan.customer_name },
            company_name: { label: 'Company Name', getValue: (loan) => loan.company_name },
            loan_amount: { label: 'Loan Amount', getValue: (loan) => `‚Çπ${parseFloat(loan.loan_amount).toFixed(2)}` },
            item_weight: { label: 'Item Weight', getValue: (loan) => `${parseFloat(loan.item_weight).toFixed(3)}g` },
            item_type: { label: 'Item Type', getValue: (loan) => loan.item_type.toUpperCase() },
            status: { label: 'Status', getValue: (loan) => {
                const statusValue = loan.status || 'active';
                const displayStatus = formatStatus(statusValue);
                // Normalize status for CSS class (use new names)
                const cssStatus = statusValue.toLowerCase() === 'delivered' ? 'released' : 
                                 statusValue.toLowerCase() === 'defaulted' ? 'unredeemed' : statusValue.toLowerCase();
                return `<span class="status ${cssStatus}">${displayStatus}</span>`;
            }},
            loan_date: { label: 'Loan Date', getValue: (loan) => formatDate(loan.loan_date) },
            item_description: { label: 'Item Description', getValue: (loan) => loan.item_description || 'N/A' },
            address: { label: 'Address', getValue: (loan) => loan.address || 'N/A' },
            cell_number: { label: 'Cell Number', getValue: (loan) => loan.cell_number || 'N/A' },
            occupation: { label: 'Occupation', getValue: (loan) => loan.occupation || 'N/A' },
            father_name: { label: 'Father Name', getValue: (loan) => loan.father_name || 'N/A' },
            husband_name: { label: 'Husband Name', getValue: (loan) => loan.husband_name || 'N/A' },
            post: { label: 'Post', getValue: (loan) => loan.post || 'N/A' },
            pin_code: { label: 'Pin Code', getValue: (loan) => loan.pin_code || 'N/A' },
            aadhar_number: { label: 'Aadhar Number', getValue: (loan) => loan.aadhar_number || 'N/A' },
            released_date: { label: 'Released Date', getValue: (loan) => loan.released_date ? formatDate(loan.released_date) : 'N/A' },
            id: { label: 'Loan ID', getValue: (loan) => loan.id }
        };
        
        // Default column configuration
        const defaultColumnConfig = [
            { field: 'serial_number', header: 'Serial No', visible: true },
            { field: 'customer_name', header: 'Customer', visible: true },
            { field: 'company_name', header: 'Company', visible: true },
            { field: 'loan_amount', header: 'Amount', visible: true },
            { field: 'item_weight', header: 'Weight', visible: true },
            { field: 'item_type', header: 'Type', visible: true },
            { field: 'status', header: 'Status', visible: true },
            { field: 'loan_date', header: 'Date', visible: true }
        ];
        
        function getColumnConfig() {
            const stored = localStorage.getItem('loanTableColumnConfig');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    return defaultColumnConfig;
                }
            }
            return defaultColumnConfig;
        }
        
        function saveColumnConfig(config) {
            localStorage.setItem('loanTableColumnConfig', JSON.stringify(config));
        }
        
        function loadColumnSettings() {
            const settingsContent = document.getElementById('settingsContent');
            const config = getColumnConfig();
            
            let html = '<h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 1.1em;">Customize Table Columns</h4>';
            
            // Current columns configuration
            html += '<div style="margin-bottom: 30px;">';
            html += '<h5 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 1em;">Current Columns (in order)</h5>';
            html += '<div id="columnList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px;">';
            
            config.forEach((col, index) => {
                const fieldInfo = availableLoanFields[col.field];
                html += `
                    <div id="col_item_${index}" style="margin-bottom: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0; display: flex; align-items: center; gap: 10px;">
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <button onclick="moveColumnUp(${index})" ${index === 0 ? 'disabled' : ''} style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; ${index === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}" title="Move up">‚Üë</button>
                            <button onclick="moveColumnDown(${index})" ${index === config.length - 1 ? 'disabled' : ''} style="background: #667eea; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em; ${index === config.length - 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}" title="Move down">‚Üì</button>
                        </div>
                        <div style="flex: 1;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 0.85em; color: #7f8c8d; display: block; margin-bottom: 5px;">Data Field</label>
                                    <select id="col_field_${index}" onchange="updateColumnField(${index})" style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px;">
                                        ${Object.keys(availableLoanFields).map(field => 
                                            `<option value="${field}" ${col.field === field ? 'selected' : ''}>${availableLoanFields[field].label}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 0.85em; color: #7f8c8d; display: block; margin-bottom: 5px;">Column Header</label>
                                    <input type="text" id="col_header_${index}" value="${col.header}" placeholder="Column name" style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px;">
                                </div>
                            </div>
                        </div>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="col_visible_${index}" ${col.visible ? 'checked' : ''} style="width: 18px; height: 18px;">
                            <span style="font-size: 0.85em; color: #7f8c8d;">Visible</span>
                        </label>
                        <button onclick="removeColumn(${index})" style="background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">Remove</button>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<button onclick="addNewColumn()" style="margin-top: 10px; background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">+ Add Column</button>';
            html += '</div>';
            
            // Available fields reference
            html += '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">';
            html += '<h5 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 0.95em;">Available Data Fields</h5>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; font-size: 0.85em; color: #7f8c8d;">';
            Object.keys(availableLoanFields).forEach(field => {
                html += `<div style="padding: 5px;">‚Ä¢ ${availableLoanFields[field].label}</div>`;
            });
            html += '</div>';
            html += '</div>';
            
            html += `
                <div class="settings-actions">
                    <button onclick="saveColumnConfigToStorage()" class="btn btn-submit">Save Configuration</button>
                    <button onclick="resetColumnConfig()" class="btn btn-secondary">Reset to Default</button>
                    <button onclick="showSettingsMenu()" class="btn btn-secondary">Back</button>
                </div>
            `;
            
            settingsContent.innerHTML = html;
        }
        
        function addNewColumn() {
            const config = getColumnConfig();
            // Add a new column with the first available field
            const firstField = Object.keys(availableLoanFields)[0];
            config.push({
                field: firstField,
                header: availableLoanFields[firstField].label,
                visible: true
            });
            saveColumnConfig(config);
            loadColumnSettings();
        }
        
        function removeColumn(index) {
            if (confirm('Remove this column?')) {
                const config = getColumnConfig();
                config.splice(index, 1);
                saveColumnConfig(config);
                loadColumnSettings();
            }
        }
        
        function updateColumnField(index) {
            const config = getColumnConfig();
            const select = document.getElementById(`col_field_${index}`);
            const headerInput = document.getElementById(`col_header_${index}`);
            const newField = select.value;
            config[index].field = newField;
            // Update header to match field label if it hasn't been customized
            if (headerInput.value === availableLoanFields[config[index].field]?.label || 
                headerInput.value === '') {
                headerInput.value = availableLoanFields[newField].label;
            }
            config[index].header = headerInput.value;
            saveColumnConfig(config);
        }
        
        function moveColumnUp(index) {
            if (index > 0) {
                const config = getColumnConfig();
                const temp = config[index];
                config[index] = config[index - 1];
                config[index - 1] = temp;
                saveColumnConfig(config);
                loadColumnSettings();
            }
        }
        
        function moveColumnDown(index) {
            const config = getColumnConfig();
            if (index < config.length - 1) {
                const temp = config[index];
                config[index] = config[index + 1];
                config[index + 1] = temp;
                saveColumnConfig(config);
                loadColumnSettings();
            }
        }
        
        function saveColumnConfigToStorage() {
            const config = getColumnConfig();
            const columnList = document.getElementById('columnList');
            const columnItems = columnList.querySelectorAll('[id^="col_item_"]');
            
            columnItems.forEach((item, index) => {
                if (config[index]) {
                    const headerInput = document.getElementById(`col_header_${index}`);
                    const visibleCheckbox = document.getElementById(`col_visible_${index}`);
                    
                    if (headerInput) {
                        config[index].header = headerInput.value.trim() || availableLoanFields[config[index].field].label;
                    }
                    if (visibleCheckbox) {
                        config[index].visible = visibleCheckbox.checked;
                    }
                }
            });
            
            saveColumnConfig(config);
            showAlert('Column configuration saved successfully!', 'success');
            
            // Refresh the loans table if we're on the loans page
            if (document.getElementById('loans').classList.contains('active')) {
                displayLoans();
            }
        }
        
        function resetColumnConfig() {
            if (confirm('Reset all columns to default configuration? This will remove all customizations.')) {
                localStorage.removeItem('loanTableColumnConfig');
                loadColumnSettings();
                showAlert('Column configuration reset to default', 'success');
            }
        }

        function loadPrefixSettings() {
            const settingsContent = document.getElementById('settingsContent');
            const prefixes = getSerialPrefixes();
            
            if (companies.length === 0) {
                settingsContent.innerHTML = '<div class="loading">Loading companies...</div>';
                return;
            }
            
            let html = '<h4 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 1.1em;">Serial Number Prefixes</h4>';
            html += '<p style="margin: 0 0 20px 0; color: #7f8c8d; font-size: 0.9em;">Configure serial number prefixes for each company and item type.</p>';
            html += '<div style="max-height: 400px; overflow-y: auto;">';
            companies.forEach(company => {
                const companyPrefixes = prefixes[company.id] || {};
                const goldPrefix = typeof companyPrefixes === 'string' ? companyPrefixes : (companyPrefixes.gold || '');
                const silverPrefix = typeof companyPrefixes === 'string' ? '' : (companyPrefixes.silver || '');
                
                html += `
                    <div class="settings-item" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block; color: #2c3e50;">${company.name}</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="font-size: 0.85em; color: #7f8c8d; margin-bottom: 5px; display: block;">Gold Prefix</label>
                                <input type="text" 
                                       id="prefix_${company.id}_gold" 
                                       value="${goldPrefix}" 
                                       placeholder="e.g., DC-" 
                                       maxlength="20"
                                       style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="font-size: 0.85em; color: #7f8c8d; margin-bottom: 5px; display: block;">Silver Prefix</label>
                                <input type="text" 
                                       id="prefix_${company.id}_silver" 
                                       value="${silverPrefix}" 
                                       placeholder="e.g., DS-" 
                                       maxlength="20"
                                       style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            html += `
                <div class="settings-actions">
                    <button onclick="saveSettings()" class="btn btn-submit">Save Settings</button>
                    <button onclick="showSettingsMenu()" class="btn btn-secondary">Back</button>
                </div>
            `;
            
            settingsContent.innerHTML = html;
        }

        function saveSettings() {
            const prefixes = {};
            companies.forEach(company => {
                const goldInput = document.getElementById(`prefix_${company.id}_gold`);
                const silverInput = document.getElementById(`prefix_${company.id}_silver`);
                
                const goldPrefix = goldInput ? goldInput.value.trim() : '';
                const silverPrefix = silverInput ? silverInput.value.trim() : '';
                
                if (goldPrefix || silverPrefix) {
                    prefixes[company.id] = {};
                    if (goldPrefix) {
                        prefixes[company.id].gold = goldPrefix;
                    }
                    if (silverPrefix) {
                        prefixes[company.id].silver = silverPrefix;
                    }
                }
            });
            
            saveSerialPrefixes(prefixes);
            showAlert('Settings saved successfully!', 'success');
            
            // Update the serial number field if a company and item type are already selected
            const companySelect = document.getElementById('company');
            const itemTypeSelect = document.getElementById('itemType');
            if (companySelect && companySelect.value && itemTypeSelect && itemTypeSelect.value) {
                updateSerialNumberPrefix(companySelect.value, itemTypeSelect.value);
            }
        }

        function updateSerialNumberPrefix(companyId, itemType) {
            const serialNumberInput = document.getElementById('serialNumber');
            if (!serialNumberInput) return;
            
            const prefix = getSerialPrefixForCompany(companyId, itemType);
            
            if (prefix) {
                // Only set prefix if the field is empty or already contains just the prefix
                if (!serialNumberInput.value || serialNumberInput.value === prefix) {
                    serialNumberInput.value = prefix;
                    serialNumberInput.focus();
                    serialNumberInput.setSelectionRange(prefix.length, prefix.length);
                }
            } else {
                // If no prefix and serial number is empty or just contains a prefix from another company/item type, clear it
                const prefixes = getSerialPrefixes();
                let hasAnyPrefix = false;
                
                // Check all company prefixes (both old format and new format)
                Object.keys(prefixes).forEach(cId => {
                    const companyPrefix = prefixes[cId];
                    if (typeof companyPrefix === 'string') {
                        if (serialNumberInput.value === companyPrefix) {
                            hasAnyPrefix = true;
                        }
                    } else {
                        if (companyPrefix.gold && serialNumberInput.value === companyPrefix.gold) {
                            hasAnyPrefix = true;
                        }
                        if (companyPrefix.silver && serialNumberInput.value === companyPrefix.silver) {
                            hasAnyPrefix = true;
                        }
                    }
                });
                
                if (hasAnyPrefix) {
                    serialNumberInput.value = '';
                }
            }
        }

        // Close settings menu when clicking outside
        document.addEventListener('click', function(event) {
            const settingsMenu = document.getElementById('settingsMenu');
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            
            if (settingsMenu && settingsMenu.classList.contains('active')) {
                if (!settingsMenu.contains(event.target) && !hamburgerMenu.contains(event.target)) {
                    settingsMenu.classList.remove('active');
                    hamburgerMenu.classList.remove('active');
                }
            }
        });

        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        function setAuthToken(token) {
            localStorage.setItem('authToken', token);
        }

        function clearAuthToken() {
            localStorage.removeItem('authToken');
        }

        function showLoginOverlay(message = '') {
            const overlay = document.getElementById('loginOverlay');
            const appContainer = document.getElementById('appContainer');
            overlay.classList.add('active');
            appContainer.classList.add('hidden');
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.reset();
            }

            if (message) {
                showLoginError(message);
            } else {
                hideLoginError();
            }
        }

        function hideLoginOverlay() {
            const overlay = document.getElementById('loginOverlay');
            overlay.classList.remove('active');
            hideLoginError();
        }

        function showAppContainer() {
            document.getElementById('appContainer').classList.remove('hidden');
        }

        function hideAppContainer() {
            document.getElementById('appContainer').classList.add('hidden');
        }

        function handleUnauthorized() {
            clearAuthToken();
            hideAppContainer();
            showLoginOverlay('Session expired. Please login again.');
            showAlert('Session expired. Please login again.', 'error');
            throw new Error('Unauthorized');
        }

        async function authFetch(url, options = {}) {
            const token = getAuthToken();
            const fetchOptions = {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...(options.headers || {})
                }
            };

            if (token) {
                fetchOptions.headers['Authorization'] = `Bearer ${token}`;
            }

            try {
                const response = await fetch(url, fetchOptions);

                if (response.status === 401) {
                    handleUnauthorized();
                    throw new Error('Unauthorized');
                }

                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        async function initializeApp() {
            if (appInitialized) {
                await loadDashboard();
                return;
            }

            appInitialized = true;

            await loadCompanies();
            await loadDashboard();
            setDefaultDate();

            const form = document.getElementById('loanForm');
            if (form) {
                console.log('Loan form found');
            } else {
                console.error('Loan form not found!');
            }
        }

        function setupLoginHandling() {
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                await login();
            });

            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showLoginError('Please enter your user ID and password');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    showLoginError(data.error || 'Invalid credentials');
                    return;
                }

                setAuthToken(data.data.token);
                hideLoginOverlay();
                showAppContainer();
                await initializeApp();
                document.getElementById('loginForm').reset();
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Unable to login. Please try again.');
            }
        }

        async function logout() {
            try {
                await authFetch('/api/auth/logout', { method: 'POST' });
            } catch (error) {
                console.warn('Logout request failed:', error);
            } finally {
                clearAuthToken();
                appInitialized = false;
                showLoginOverlay();
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideLoginError() {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = '';
            errorDiv.classList.add('hidden');
        }

        // Function to disable autocomplete on all form fields
        function disableAutocomplete() {
            const loanForm = document.getElementById('loanForm');
            if (loanForm) {
                // Set form autocomplete to off
                loanForm.setAttribute('autocomplete', 'off');
                loanForm.setAttribute('data-form-type', 'other');
                
                const inputs = loanForm.querySelectorAll('input, textarea');
                inputs.forEach((input, index) => {
                    // Skip hidden fields and buttons
                    if (input.type === 'hidden' || input.type === 'submit' || input.type === 'button') {
                        return;
                    }
                    
                    // For text inputs and textareas
                    if (input.type === 'text' || input.type === 'tel' || input.tagName === 'TEXTAREA') {
                        // Multiple autocomplete values to confuse Chrome
                        input.setAttribute('autocomplete', 'new-password');
                        input.setAttribute('data-lpignore', 'true');
                        input.setAttribute('data-form-type', 'other');
                        input.setAttribute('autocapitalize', 'off');
                        input.setAttribute('autocorrect', 'off');
                        input.setAttribute('spellcheck', 'false');
                        
                        // Aggressive readonly trick
                        input.setAttribute('readonly', 'readonly');
                        
                        // Remove readonly on multiple events - immediate removal
                        const removeReadonly = function() {
                            if (input.hasAttribute('readonly')) {
                                input.removeAttribute('readonly');
                            }
                        };
                        
                        // Immediate removal on any interaction
                        input.addEventListener('focus', removeReadonly, { once: false });
                        input.addEventListener('mousedown', removeReadonly, { once: false });
                        input.addEventListener('touchstart', removeReadonly, { once: false });
                        input.addEventListener('click', removeReadonly, { once: false });
                        input.addEventListener('keydown', removeReadonly, { once: false });
                        input.addEventListener('keyup', removeReadonly, { once: false });
                        
                        // Clear any autofill on input
                        input.addEventListener('input', function() {
                            if (this.hasAttribute('readonly')) {
                                this.removeAttribute('readonly');
                            }
                        });
                        
                        // Force remove readonly after a short delay to ensure it's removed
                        setTimeout(() => {
                            if (input.hasAttribute('readonly')) {
                                input.removeAttribute('readonly');
                            }
                        }, 100);
                    } 
                    // For number and date inputs
                    else if (input.type === 'number' || input.type === 'date') {
                        input.setAttribute('autocomplete', 'off');
                        input.setAttribute('data-lpignore', 'true');
                        input.setAttribute('data-form-type', 'other');
                    }
                    
                    // Add a unique name attribute to prevent Chrome from recognizing patterns
                    if (!input.name) {
                        input.setAttribute('name', `field_${Date.now()}_${index}`);
                    }
                });
                
                // Add hidden dummy fields to confuse autofill
                const dummyFields = ['email', 'username', 'password', 'name', 'address'];
                dummyFields.forEach(field => {
                    const dummy = document.createElement('input');
                    dummy.type = 'text';
                    dummy.style.display = 'none';
                    dummy.setAttribute('tabindex', '-1');
                    dummy.setAttribute('autocomplete', 'off');
                    dummy.setAttribute('name', field);
                    loanForm.insertBefore(dummy, loanForm.firstChild);
                });
                
                // Re-apply autocomplete prevention on form focus
                loanForm.addEventListener('focusin', function(e) {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        const input = e.target;
                        if (input.type === 'text' || input.type === 'tel' || input.tagName === 'TEXTAREA') {
                            input.setAttribute('autocomplete', 'new-password');
                            input.setAttribute('readonly', 'readonly');
                            setTimeout(() => {
                                input.removeAttribute('readonly');
                            }, 10);
                        }
                    }
                }, true);
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            setupLoginHandling();

            if (getAuthToken()) {
                try {
                    showAppContainer();
                    hideLoginOverlay();
                    await initializeApp();
                    // Disable autocomplete after form is loaded - multiple calls for reliability
                    setTimeout(disableAutocomplete, 100);
                    setTimeout(disableAutocomplete, 300);
                    setTimeout(disableAutocomplete, 500);
                } catch (error) {
                    console.error('Initialization error:', error);
                    handleUnauthorized();
                }
            } else {
                showLoginOverlay();
            }
        });
        
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('loanDate').value = today;
        }
        
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked nav link
            event.target.classList.add('active');
            
            // Ensure companies are loaded and dropdowns are populated when showing sections that need them
            if (['new-loan', 'loans', 'master-sheet', 'mailing-label'].includes(sectionId)) {
                if (companies && companies.length > 0) {
                    // Companies already loaded, just populate dropdowns
                    populateCompanyDropdowns();
                } else {
                    // Companies not loaded yet, load them
                    loadCompanies().then(() => {
                        // After loading, populate dropdowns
                        populateCompanyDropdowns();
                    });
                }
            }
            
            // Load section-specific data
            if (sectionId === 'dashboard') {
                loadDashboard();
            } else if (sectionId === 'loans') {
                loadLoans();
            } else if (sectionId === 'new-loan') {
                setDefaultDate();
                setTimeout(disableAutocomplete, 100);
                setTimeout(disableAutocomplete, 300);
                setTimeout(disableAutocomplete, 500);
            }
        }
        
        // Helper function to populate company dropdowns
        function populateCompanyDropdowns() {
            if (!companies || companies.length === 0) {
                console.warn('No companies available to populate dropdowns');
                return false;
            }
            
            const companySelects = [
                { id: 'company', placeholder: 'Select Company' },
                { id: 'filterCompany', placeholder: 'All Companies' },
                { id: 'msCompany', placeholder: 'Select Company' },
                { id: 'mailingLabelCompany', placeholder: 'Select Company' }
            ];
            
            let allPopulated = true;
            companySelects.forEach(({ id, placeholder }) => {
                const select = document.getElementById(id);
                if (select) {
                    // Clear existing options
                    select.innerHTML = '';
                    
                    // Add placeholder option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = placeholder;
                    select.appendChild(defaultOption);
                    
                    // Add company options
                    companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;
                        option.textContent = company.name;
                        select.appendChild(option);
                    });
                    console.log(`Populated dropdown: ${id} with ${companies.length} companies`);
                } else {
                    console.warn(`Dropdown element not found: ${id}`);
                    allPopulated = false;
                }
            });
            
            return allPopulated;
        }

        async function loadCompanies() {
            try {
                const response = await authFetch('/api/companies');
                
                if (!response.ok) {
                    let errorText = '';
                    try {
                        errorText = await response.text();
                    } catch (e) {
                        errorText = 'Unknown error';
                    }
                    console.error('Companies API error:', response.status, errorText);
                    throw new Error(`Failed to load companies: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response from companies API:', text.substring(0, 200));
                    throw new Error('Invalid response format from server');
                }
                
                const data = await response.json();
                
                if (data.success && data.data && Array.isArray(data.data)) {
                    companies = data.data;
                    console.log('Loaded companies:', companies.length, companies);
                    
                    // Populate company dropdowns
                    populateCompanyDropdowns();
                    
                    // Add event listener for company dropdown in new loan form to auto-fill serial number prefix
                    const companySelect = document.getElementById('company');
                    const itemTypeSelect = document.getElementById('itemType');
                    const serialNumberInput = document.getElementById('serialNumber');
                    
                    // Function to update prefix based on both company and item type
                    function updatePrefixIfNeeded() {
                        const companyId = companySelect ? companySelect.value : '';
                        const itemType = itemTypeSelect ? itemTypeSelect.value : '';
                        
                        if (companyId && itemType) {
                            updateSerialNumberPrefix(companyId, itemType);
                        } else {
                            // Clear serial number if company or item type is not selected and it matches any prefix
                            const prefixes = getSerialPrefixes();
                            let hasAnyPrefix = false;
                            
                            Object.keys(prefixes).forEach(cId => {
                                const companyPrefix = prefixes[cId];
                                if (typeof companyPrefix === 'string') {
                                    if (serialNumberInput.value === companyPrefix) {
                                        hasAnyPrefix = true;
                                    }
                                } else {
                                    if (companyPrefix.gold && serialNumberInput.value === companyPrefix.gold) {
                                        hasAnyPrefix = true;
                                    }
                                    if (companyPrefix.silver && serialNumberInput.value === companyPrefix.silver) {
                                        hasAnyPrefix = true;
                                    }
                                }
                            });
                            
                            if (hasAnyPrefix) {
                                serialNumberInput.value = '';
                            }
                        }
                    }
                    
                    if (companySelect && serialNumberInput) {
                        companySelect.onchange = updatePrefixIfNeeded;
                    }
                    
                    if (itemTypeSelect && serialNumberInput) {
                        itemTypeSelect.onchange = updatePrefixIfNeeded;
                    }
                } else {
                    console.error('Invalid companies response:', data);
                    showAlert('Error loading companies: Invalid response', 'error');
                    companies = [];
                }
            } catch (error) {
                console.error('Error loading companies:', error);
                showAlert('Error loading companies: ' + (error.message || 'Unknown error'), 'error');
                // If companies fail to load, still try to continue
                companies = [];
            }
        }
        
        async function loadDashboard() {
            try {
                const statsGrid = document.getElementById('statsGrid');
                const recentLoans = document.getElementById('recentLoans');
                
                if (!statsGrid || !recentLoans) {
                    console.error('Dashboard elements not found');
                    return;
                }
                
                // Load company statistics
                let totalStats = { totalLoans: 0, totalAmount: 0, totalWeight: 0, activeLoans: 0 };
                
                if (companies && companies.length > 0) {
                    for (const company of companies) {
                        try {
                            const response = await authFetch(`/api/companies/${company.id}/stats`);
                            
                            if (!response.ok) {
                                console.error(`Failed to load stats for company ${company.id}:`, response.status);
                                continue;
                            }
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                const stats = data.data;
                                totalStats.totalLoans += stats.totalLoans;
                                totalStats.totalAmount += stats.totalAmount;
                                totalStats.totalWeight += stats.totalWeight;
                                totalStats.activeLoans += stats.activeLoans;
                            }
                        } catch (error) {
                            console.error(`Error loading stats for company ${company.id}:`, error);
                        }
                    }
                }
                
                // Display statistics
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h3>${totalStats.totalLoans}</h3>
                        <p>Total Loans</p>
                    </div>
                    <div class="stat-card">
                        <h3>‚Çπ${totalStats.totalAmount.toFixed(2)}</h3>
                        <p>Total Amount</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalStats.totalWeight.toFixed(3)}g</h3>
                        <p>Total Weight</p>
                    </div>
                    <div class="stat-card">
                        <h3>${totalStats.activeLoans}</h3>
                        <p>Active Loans</p>
                    </div>
                `;
                
                // Load all loans for pagination
                try {
                    const loansResponse = await authFetch('/api/loans?limit=1000');
                    
                    if (!loansResponse.ok) {
                        let errorText = '';
                        try {
                            errorText = await loansResponse.text();
                        } catch (e) {
                            errorText = 'Unknown error';
                        }
                        console.error('Failed to load loans:', loansResponse.status, errorText);
                        recentLoans.innerHTML = '<p>Error loading loans</p>';
                        return;
                    }
                    
                    const contentType = loansResponse.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await loansResponse.text();
                        console.error('Non-JSON response from loans API:', text.substring(0, 200));
                        recentLoans.innerHTML = '<p>Error: Invalid response format</p>';
                        return;
                    }
                    
                    const loansData = await loansResponse.json();
                    
                    if (loansData.success && loansData.data && loansData.data.loans) {
                        const allLoansData = loansData.data.loans;
                        console.log('Loaded loans:', allLoansData.length);
                        allLoans.dashboard = allLoansData;
                        totalPages.dashboard = Math.ceil(allLoansData.length / 10);
                        if (currentPage.dashboard > totalPages.dashboard) {
                            currentPage.dashboard = 1;
                        }
                        
                        if (allLoansData.length > 0) {
                            displayDashboardLoans();
                        } else {
                            recentLoans.innerHTML = '<p>No loans found</p>';
                        }
                    } else {
                        console.error('Invalid loans response:', loansData);
                        recentLoans.innerHTML = '<p>Error loading loans data</p>';
                    }
                } catch (error) {
                    console.error('Error loading loans:', error);
                    recentLoans.innerHTML = '<p>Error loading loans</p>';
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('Error loading dashboard data: ' + (error.message || 'Unknown error'), 'error');
            }
        }
        
        // Page navigation functions
        function goToDashboardPage(page) {
            if (page >= 1 && page <= totalPages.dashboard) {
                currentPage.dashboard = page;
                displayDashboardLoans();
            }
        }
        
        function displayDashboardLoans() {
            const recentLoans = document.getElementById('recentLoans');
            const allLoansData = allLoans.dashboard;
            const startIndex = (currentPage.dashboard - 1) * 10;
            const endIndex = startIndex + 10;
            const loans = allLoansData.slice(startIndex, endIndex);
            
            if (allLoansData.length > 0) {
                recentLoans.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Serial No</th>
                                <th>Customer</th>
                                <th>Company</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${loans.map(loan => `
                                <tr>
                                    <td>${loan.serial_number || loan.serialNumber || 'N/A'}</td>
                                    <td>${loan.customer_name}</td>
                                    <td>${loan.company_name}</td>
                                    <td>‚Çπ${parseFloat(loan.loan_amount).toFixed(2)}</td>
                                    <td><span class="status ${loan.status === 'delivered' ? 'released' : loan.status === 'defaulted' ? 'unredeemed' : loan.status}">${formatStatus(loan.status)}</span></td>
                                    <td>${formatDate(loan.loan_date)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${generatePagination('dashboard', currentPage.dashboard, totalPages.dashboard, 'goToDashboardPage')}
                `;
            }
        }
        
        // Loan form reset handler
        document.getElementById('loanForm').addEventListener('reset', function() {
            setTimeout(() => {
                setDefaultDate();
            }, 0);
        });

        // Loan form submission
        document.getElementById('loanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            const formData = {
                serialNumber: document.getElementById('serialNumber').value,
                companyId: document.getElementById('company').value,
                customerName: document.getElementById('customerName').value,
                fatherName: document.getElementById('fatherName').value,
                husbandName: '', // This will be handled by the backend
                address: document.getElementById('address').value,
                post: document.getElementById('post').value,
                pinCode: document.getElementById('pinCode').value,
                occupation: document.getElementById('occupation').value,
                cellNumber: document.getElementById('cellNumber').value,
                loanAmount: document.getElementById('loanAmount').value,
                itemWeight: document.getElementById('itemWeight').value,
                itemDescription: document.getElementById('itemDescription').value,
                itemType: document.getElementById('itemType').value,
                loanDate: document.getElementById('loanDate').value,
                aadharNumber: document.getElementById('aadharNumber').value
            };
            
            console.log('Form data:', formData);
            
            // Validate required fields
            if (!formData.serialNumber || !formData.companyId || !formData.customerName || !formData.address || 
                !formData.loanAmount || !formData.itemWeight || !formData.itemDescription || !formData.itemType) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                console.log('Sending request to /api/loans');
                const response = await authFetch('/api/loans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    showAlert('Loan created successfully!', 'success');
                    document.getElementById('loanForm').reset();
                    setDefaultDate();
                } else {
                    showAlert(data.error || 'Error creating loan', 'error');
                }
            } catch (error) {
                console.error('Error creating loan:', error);
                showAlert('Error creating loan: ' + error.message, 'error');
            }
        });
        
        async function loadLoans() {
            try {
                const companyId = document.getElementById('filterCompany').value;
                const status = document.getElementById('filterStatus').value;
                const searchTerm = document.getElementById('loanSearch') ? document.getElementById('loanSearch').value.trim() : '';
                
                let url = '/api/loans?limit=1000';
                if (companyId) url += `&companyId=${companyId}`;
                if (status) url += `&status=${status}`;
                if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
                
                const loansTable = document.getElementById('loansTable');
                loansTable.innerHTML = '<div class="loading">Searching loans...</div>';

                const response = await authFetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const loans = data.data.loans;
                    let filteredLoans = loans;

                    if (searchTerm) {
                        const searchLower = searchTerm.toLowerCase();
                        filteredLoans = loans.filter(loan => {
                            const serialMatch = loan.serial_number && loan.serial_number.toLowerCase().includes(searchLower);
                            const nameMatch = loan.customer_name && loan.customer_name.toLowerCase().includes(searchLower);
                            const phoneMatch = loan.cell_number && loan.cell_number.toLowerCase().includes(searchLower);
                            return serialMatch || nameMatch || phoneMatch;
                        });
                    }
                    
                    // Store all loans and reset to page 1 when filters change
                    allLoans.loans = filteredLoans;
                    currentPage.loans = 1;
                    totalPages.loans = Math.ceil(filteredLoans.length / 10);
                    
                    if (filteredLoans.length > 0) {
                        displayLoans();
                    } else {
                        loansTable.innerHTML = searchTerm 
                            ? `<p>No loans found for "<strong>${searchTerm}</strong>"</p>`
                            : '<p>No loans found</p>';
                    }
                } else {
                    showAlert(data.error || 'Error loading loans', 'error');
                }
            } catch (error) {
                console.error('Error loading loans:', error);
                showAlert('Error loading loans', 'error');
            }
        }
        
        function goToLoansPage(page) {
            if (page >= 1 && page <= totalPages.loans) {
                currentPage.loans = page;
                displayLoans();
            }
        }
        
        function displayLoans() {
            const loansTable = document.getElementById('loansTable');
            const allLoansData = allLoans.loans;
            const startIndex = (currentPage.loans - 1) * 10;
            const endIndex = startIndex + 10;
            const loans = allLoansData.slice(startIndex, endIndex);
            
            // Get column configuration
            const columnConfig = getColumnConfig();
            
            if (allLoansData.length > 0) {
                // Build header row - only show visible columns
                let headerRow = '<thead><tr>';
                const visibleColumns = columnConfig.filter(col => col.visible);
                
                visibleColumns.forEach(col => {
                    headerRow += `<th>${col.header}</th>`;
                });
                
                // Always add Actions column
                headerRow += '<th>Actions</th>';
                headerRow += '</tr></thead>';
                
                // Build body rows
                let bodyRows = '<tbody>';
                loans.forEach(loan => {
                    bodyRows += '<tr>';
                    
                    // Add data cells based on column configuration
                    visibleColumns.forEach(col => {
                        const fieldInfo = availableLoanFields[col.field];
                        let value = 'N/A';
                        
                        if (fieldInfo) {
                            value = fieldInfo.getValue(loan);
                            // If getValue returns N/A, try direct access as fallback
                            if (value === 'N/A') {
                                // Try multiple field name variations
                                const fieldVariations = [
                                    col.field,
                                    col.field.replace(/_/g, ''),
                                    col.field.replace(/([a-z])([A-Z])/g, '$1_$2').toLowerCase(),
                                    col.field.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase())
                                ];
                                
                                for (const fieldName of fieldVariations) {
                                    if (loan[fieldName] !== undefined && loan[fieldName] !== null && loan[fieldName] !== '') {
                                        value = String(loan[fieldName]);
                                        break;
                                    }
                                }
                            }
                        } else {
                            // Fallback: try to get value directly from loan object
                            value = loan[col.field] || loan[col.field.replace(/_/g, '')] || 'N/A';
                        }
                        
                        bodyRows += `<td>${value}</td>`;
                    });
                    
                    // Always add Actions cell
                    bodyRows += `<td><button onclick="viewLoanDetails(${loan.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">View Details</button></td>`;
                    bodyRows += '</tr>';
                });
                bodyRows += '</tbody>';
                
                loansTable.innerHTML = `
                    <table class="table">
                        ${headerRow}
                        ${bodyRows}
                    </table>
                    ${generatePagination('loans', currentPage.loans, totalPages.loans, 'goToLoansPage')}
                `;
            }
        }

        const loanSearchInput = document.getElementById('loanSearch');
        if (loanSearchInput) {
            loanSearchInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    loadLoans();
                }
            });
        }
        
        async function deliverLoan(loanId) {
            if (confirm('Mark this loan as released?')) {
                try {
                    const response = await authFetch(`/api/loans/${loanId}/deliver`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ releasedDate: new Date().toISOString().split('T')[0] })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('Loan marked as released', 'success');
                        loadLoans();
                        // Refresh loan details in modal if it's open
                        await refreshLoanDetailsIfOpen();
                    } else {
                        showAlert(data.error || 'Error releasing loan', 'error');
                    }
                } catch (error) {
                    console.error('Error releasing loan:', error);
                    showAlert('Error releasing loan', 'error');
                }
            }
        }
        
        async function defaultLoan(loanId) {
            if (confirm('Mark this loan as unredeemed?')) {
                try {
                    const response = await authFetch(`/api/loans/${loanId}/default`, {
                        method: 'PATCH'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('Loan marked as unredeemed', 'success');
                        loadLoans();
                        // Refresh loan details in modal if it's open
                        await refreshLoanDetailsIfOpen();
                    } else {
                        showAlert(data.error || 'Error marking loan as unredeemed', 'error');
                    }
                } catch (error) {
                    console.error('Error marking loan as unredeemed:', error);
                    showAlert('Error marking loan as unredeemed', 'error');
                }
            }
        }
        
        async function undoLoanAction(loanId) {
            if (confirm('Undo this action and revert loan status back to active?')) {
                try {
                    const response = await authFetch(`/api/loans/${loanId}/undo`, {
                        method: 'PATCH'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('Loan status reverted to active successfully', 'success');
                        loadLoans();
                        loadDashboard();
                        // Refresh loan details in modal if it's open
                        await refreshLoanDetailsIfOpen();
                    } else {
                        showAlert(data.error || 'Error undoing loan action', 'error');
                    }
                } catch (error) {
                    console.error('Error undoing loan action:', error);
                    showAlert('Error undoing loan action', 'error');
                }
            }
        }
        
        async function generateMailingLabel(loanId) {
            // If loanId is provided (from modal), use it directly
            if (loanId) {
                try {
                    const response = await authFetch(`/api/loans/${loanId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // Switch to mailing label section first
                        document.querySelectorAll('.section').forEach(section => {
                            section.classList.remove('active');
                        });
                        document.querySelectorAll('.nav a').forEach(link => {
                            link.classList.remove('active');
                        });
                        document.getElementById('mailing-label').classList.add('active');
                        document.querySelectorAll('.nav a').forEach(link => {
                            if (link.getAttribute('onclick') && link.getAttribute('onclick').includes('mailing-label')) {
                                link.classList.add('active');
                            }
                        });
                        
                        displayMailingLabels([data.data]);
                        closeLoanDetails();
                        return;
                    } else {
                        showAlert(data.error || 'Error loading loan', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('Error generating mailing label:', error);
                    showAlert('Error generating mailing label', 'error');
                    return;
                }
            }
            
            // Otherwise, get from input field
            const inputValue = document.getElementById('mailingLabelLoanId').value.trim();
            
            if (!inputValue) {
                showAlert('Please enter Loan IDs or Serial Numbers', 'error');
                return;
            }
            
            // Parse input - support both comma-separated and line-separated
            const identifiers = inputValue
                .split(/[,\n]/)
                .map(id => id.trim())
                .filter(id => id.length > 0);
            
            if (identifiers.length === 0) {
                showAlert('Please enter at least one Loan ID or Serial Number', 'error');
                return;
            }
            
            const resultDiv = document.getElementById('mailingLabelResult');
            resultDiv.innerHTML = '<div class="loading">Loading loans...</div>';
            
            try {
                const loans = [];
                const errors = [];
                
                // Fetch all loans
                for (const identifier of identifiers) {
                    try {
                        // Try to fetch by ID first
                        let response = await authFetch(`/api/loans/${identifier}`);
                        
                        // If not found by ID, try searching by serial number
                        if (!response.ok) {
                            const searchResponse = await authFetch(`/api/loans?search=${encodeURIComponent(identifier)}&limit=1`);
                            const searchData = await searchResponse.json();
                            
                            if (searchData.success && searchData.data.loans.length > 0) {
                                loans.push(searchData.data.loans[0]);
                            } else {
                                errors.push(`Not found: ${identifier}`);
                            }
                        } else {
                            const data = await response.json();
                            if (data.success) {
                                loans.push(data.data);
                            } else {
                                errors.push(`Error loading: ${identifier}`);
                            }
                        }
                    } catch (error) {
                        errors.push(`Error loading: ${identifier}`);
                    }
                }
                
                if (loans.length > 0) {
                    displayMailingLabels(loans);
                    if (errors.length > 0) {
                        showAlert(`Generated ${loans.length} label(s). ${errors.length} error(s): ${errors.join(', ')}`, 'error');
                    }
                } else {
                    showAlert('No loans found. ' + (errors.length > 0 ? errors.join(', ') : ''), 'error');
                    resultDiv.innerHTML = '';
                }
            } catch (error) {
                console.error('Error generating mailing labels:', error);
                showAlert('Error generating mailing labels', 'error');
                resultDiv.innerHTML = '';
            }
        }
        
        async function generateMailingLabelByCompany() {
            const companyId = document.getElementById('mailingLabelCompany').value;
            const status = document.getElementById('mailingLabelStatus').value;
            const startDate = document.getElementById('mailingLabelStartDate').value;
            const endDate = document.getElementById('mailingLabelEndDate').value;
            
            if (!companyId) {
                showAlert('Please select a company', 'error');
                return;
            }
            
            const resultDiv = document.getElementById('mailingLabelResult');
            resultDiv.innerHTML = '<div class="loading">Loading loans...</div>';
            
            try {
                let url = `/api/loans?companyId=${companyId}&limit=1000`;
                const params = [];
                
                if (status) {
                    params.push(`status=${status}`);
                }
                if (startDate) {
                    params.push(`startDate=${startDate}`);
                }
                if (endDate) {
                    params.push(`endDate=${endDate}`);
                }
                
                if (params.length > 0) {
                    url += '&' + params.join('&');
                }
                
                const response = await authFetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const loans = data.data.loans;
                    
                    if (loans.length > 0) {
                        displayMailingLabels(loans);
                        showAlert(`Generated ${loans.length} mailing label(s) for selected company`, 'success');
                    } else {
                        showAlert('No loans found for the selected company and filters', 'error');
                        resultDiv.innerHTML = '';
                    }
                } else {
                    showAlert(data.error || 'Error loading loans', 'error');
                    resultDiv.innerHTML = '';
                }
            } catch (error) {
                console.error('Error generating mailing labels by company:', error);
                showAlert('Error generating mailing labels by company', 'error');
                resultDiv.innerHTML = '';
            }
        }
        
        // Store loans data globally for print function
        let currentMailingLabelLoans = [];
        
        function displayMailingLabels(loans) {
            const resultDiv = document.getElementById('mailingLabelResult');
            currentMailingLabelLoans = loans; // Store for print function
            
            const labelsHTML = loans.map(loan => {
                // Format date
                const loanDate = formatDate(loan.loan_date);
                
                // Get father/husband name
                const fatherHusbandName = loan.father_name || loan.husband_name || '';
                
                // Format phone number
                const phoneNumber = loan.cell_number || 'N/A';
                
                return `
                    <div style="background: white; padding: 5px; border-radius: 4px; border: 1px solid #e0e0e0; font-family: 'Courier New', monospace; line-height: 1.1; margin-bottom: 20px; page-break-inside: avoid;">
                        <div style="font-weight: bold; font-size: 16px; margin-bottom: 2px; padding-bottom: 2px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; width: 100%;">
                            <span>‚Çπ${parseFloat(loan.loan_amount).toFixed(2)}</span>
                            <span>${loanDate}</span>
                            <span>${loan.serial_number}</span>
                        </div>
                        <div style="margin-bottom: 1px; font-size: 15px;">
                            ${loan.customer_name}
                        </div>
                        <div style="margin-bottom: 1px; font-size: 15px;">
                            ${fatherHusbandName || 'N/A'}
                        </div>
                        <div style="margin-bottom: 1px; font-size: 15px;">
                            ${loan.address}
                        </div>
                        <div style="font-size: 15px;">
                            ${phoneNumber}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultDiv.innerHTML = `
                <div class="form-section" style="margin-top: 30px;">
                    <div class="form-section-header">
                        <div class="form-section-icon">üìÆ</div>
                        <h3>Mailing Labels (${loans.length})</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                        ${labelsHTML}
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="printMailingLabel()" class="btn btn-submit">Print All Mailing Labels</button>
                    </div>
                </div>
            `;
        }
        
        function printMailingLabel() {
            if (!currentMailingLabelLoans || currentMailingLabelLoans.length === 0) {
                showAlert('No mailing labels to print', 'error');
                return;
            }
            
            // Format loans for printing
            const formattedLoans = currentMailingLabelLoans.map(loan => {
                const loanDate = formatDate(loan.loan_date);
                const fatherHusbandName = loan.father_name || loan.husband_name || '';
                const phoneNumber = loan.cell_number || 'N/A';
                
                return {
                    amount: parseFloat(loan.loan_amount).toFixed(2),
                    date: loanDate,
                    serial: loan.serial_number,
                    name: loan.customer_name,
                    fatherHusband: fatherHusbandName || 'N/A',
                    address: loan.address,
                    phone: phoneNumber
                };
            });
            
            // Group labels into rows of 2
            const labelsPerRow = 2;
            const rows = [];
            for (let i = 0; i < formattedLoans.length; i += labelsPerRow) {
                rows.push(formattedLoans.slice(i, i + labelsPerRow));
            }
            
            const rowsHTML = rows.map(row => {
                const labelsHTML = row.map(loan => {
                    return `
                        <div class="mailing-label">
                            <div class="header-row">
                                <span>‚Çπ${loan.amount}</span>
                                <span>${loan.date}</span>
                                <span>${loan.serial}</span>
                            </div>
                            <div class="row">${loan.name}</div>
                            <div class="row">${loan.fatherHusband}</div>
                            <div class="row">${loan.address}</div>
                            <div class="row">${loan.phone}</div>
                        </div>
                    `;
                }).join('');
                // Fill empty slot if row has only 1 label
                const emptySlots = labelsPerRow - row.length;
                const emptyHTML = Array(emptySlots).fill('<div class="mailing-label empty"></div>').join('');
                return `<div class="label-row">${labelsHTML}${emptyHTML}</div>`;
            }).join('');
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Mailing Labels</title>
                        <style>
                            @page {
                                size: A4 landscape;
                                margin: 0.25in;
                            }
                            body {
                                font-family: 'Courier New', monospace;
                                padding: 0;
                                margin: 0;
                                width: 100%;
                            }
                            .label-row {
                                width: 100%;
                                margin-bottom: 0.1in;
                                page-break-inside: avoid;
                                display: flex;
                                gap: 0.1in;
                                justify-content: flex-start;
                            }
                            .label-row:last-child {
                                margin-bottom: 0;
                            }
                            .mailing-label {
                                background: white;
                                padding: 5px;
                                border-radius: 4px;
                                border: 1px solid #e0e0e0;
                                font-family: 'Courier New', monospace;
                                line-height: 1.1;
                                width: calc(50% - 0.05in);
                                max-width: calc(50% - 0.05in);
                                min-width: calc(50% - 0.05in);
                                box-sizing: border-box;
                            }
                            .mailing-label.empty {
                                background: transparent;
                                border: none;
                            }
                            .mailing-label .header-row {
                                font-weight: bold;
                                font-size: 14px;
                                margin-bottom: 2px;
                                padding-bottom: 2px;
                                border-bottom: 1px solid #333;
                                display: flex;
                                justify-content: space-between;
                                width: 100%;
                            }
                            .mailing-label .row {
                                margin-bottom: 1px;
                                font-size: 13px;
                            }
                            @media print {
                                @page {
                                    size: A4 landscape;
                                    margin: 0.25in;
                                }
                                body { 
                                    margin: 0; 
                                    padding: 0; 
                                    width: 100%;
                                }
                                .label-row {
                                    page-break-inside: avoid;
                                    margin-bottom: 0.1in;
                                    display: flex;
                                    gap: 0.1in;
                                    justify-content: flex-start;
                                    width: 100%;
                                }
                                .label-row:last-child {
                                    margin-bottom: 0;
                                }
                                .mailing-label {
                                    page-break-inside: avoid;
                                    width: calc(50% - 0.05in);
                                    max-width: calc(50% - 0.05in);
                                    min-width: calc(50% - 0.05in);
                                    flex: none;
                                    box-sizing: border-box;
                                    padding: 5px;
                                    border-radius: 4px;
                                    border: 1px solid #e0e0e0;
                                    line-height: 1.1;
                                }
                                .mailing-label.empty {
                                    background: transparent;
                                    border: none;
                                }
                                .mailing-label .header-row {
                                    margin-bottom: 2px;
                                    padding-bottom: 2px;
                                    border-bottom: 1px solid #333;
                                }
                                .mailing-label .row {
                                    margin-bottom: 1px;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        ${rowsHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
        
        async function loadMasterSheet() {
            try {
                const companyId = document.getElementById('msCompany').value;
                const status = document.getElementById('msStatus').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!companyId) {
                    showAlert('Please select a company', 'error');
                    return;
                }
                
                let url = `/api/master-sheet/${companyId}`;
                const params = [];
                
                if (startDate) params.push(`startDate=${startDate}`);
                if (endDate) params.push(`endDate=${endDate}`);
                if (status) params.push(`status=${status}`);
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }
                
                const response = await authFetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const { loans, summary } = data.data;
                    const resultDiv = document.getElementById('masterSheetResult');
                    
                    // Store all loans and reset to page 1
                    allLoans.masterSheet = loans;
                    currentPage.masterSheet = 1;
                    totalPages.masterSheet = Math.ceil(loans.length / 10);
                    
                    // Store summary for display
                    window.masterSheetSummary = summary;
                    
                    displayMasterSheetLoans();
                } else {
                    showAlert(data.error || 'Error loading master sheet', 'error');
                }
            } catch (error) {
                console.error('Error loading master sheet:', error);
                showAlert('Error loading master sheet', 'error');
            }
        }
        
        function goToMasterSheetPage(page) {
            if (page >= 1 && page <= totalPages.masterSheet) {
                currentPage.masterSheet = page;
                displayMasterSheetLoans();
            }
        }
        
        function displayMasterSheetLoans() {
            const resultDiv = document.getElementById('masterSheetResult');
            const allLoansData = allLoans.masterSheet;
            const summary = window.masterSheetSummary;
            const startIndex = (currentPage.masterSheet - 1) * 10;
            const endIndex = startIndex + 10;
            const loans = allLoansData.slice(startIndex, endIndex);
            
            resultDiv.innerHTML = `
                <h3>Summary</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>${summary.totalLoans}</h3>
                        <p>Total Loans</p>
                    </div>
                    <div class="stat-card">
                        <h3>‚Çπ${summary.totalAmount.toFixed(2)}</h3>
                        <p>Total Amount</p>
                    </div>
                    <div class="stat-card">
                        <h3>${summary.totalWeight.toFixed(3)}g</h3>
                        <p>Total Weight</p>
                    </div>
                    <div class="stat-card">
                        <h3>${summary.activeLoans}</h3>
                        <p>Active Loans</p>
                    </div>
                </div>
                
                <h3>Loans</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Serial No</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Weight</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${loans.map(loan => `
                            <tr>
                                <td>${loan.serial_number || loan.serialNumber || 'N/A'}</td>
                                <td>${formatDate(loan.loan_date)}</td>
                                <td>${loan.customer_name}</td>
                                <td>‚Çπ${parseFloat(loan.loan_amount).toFixed(2)}</td>
                                <td>${parseFloat(loan.item_weight).toFixed(3)}g</td>
                                <td>${loan.item_type.toUpperCase()}</td>
                                <td><span class="status ${loan.status}">${loan.status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${generatePagination('masterSheet', currentPage.masterSheet, totalPages.masterSheet, 'goToMasterSheetPage')}
            `;
        }
        
        async function exportMasterSheet() {
            try {
                const companyId = document.getElementById('msCompany').value;
                const status = document.getElementById('msStatus').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!companyId) {
                    showAlert('Please select a company', 'error');
                    return;
                }
                
                let url = `/api/master-sheet/${companyId}/export`;
                const params = [];
                
                if (startDate) params.push(`startDate=${startDate}`);
                if (endDate) params.push(`endDate=${endDate}`);
                if (status) params.push(`status=${status}`);
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }

                const response = await authFetch(url);

                if (!response.ok) {
                    const errorText = await response.text();
                    showAlert(errorText || 'Error exporting master sheet', 'error');
                    return;
                }

                const blob = await response.blob();
                const downloadUrl = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = 'master-sheet.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(downloadUrl), 60_000);

                showAlert('Excel file downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error exporting master sheet:', error);
                showAlert('Error exporting master sheet', 'error');
            }
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // Insert at the top of the content area
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            const dateTimeString = now.toLocaleString('en-US', options);
            document.getElementById('datetime').textContent = dateTimeString;
        }
        
        // Update immediately and then every second
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        // View loan details modal functions
        async function viewLoanDetails(loanId) {
            const modal = document.getElementById('loanDetailsModal');
            const content = document.getElementById('loanDetailsContent');
            const footer = document.getElementById('loanDetailsFooter');
            const buttons = document.getElementById('loanDetailsButtons');
            
            // Store current loan ID
            currentLoanDetailsId = loanId;
            
            // Show modal
            modal.classList.add('active');
            content.innerHTML = '<div class="loading">Loading loan details...</div>';
            footer.style.display = 'none';
            
            try {
                const response = await authFetch(`/api/loans/${loanId}`);
                const data = await response.json();
                
                if (data.success) {
                    const loan = data.data;
                    content.innerHTML = generateLoanDetailsHTML(loan);
                    buttons.innerHTML = generateLoanButtonsHTML(loan);
                    footer.style.display = 'block';
                } else {
                    content.innerHTML = '<div class="alert alert-error">Error loading loan details</div>';
                }
            } catch (error) {
                console.error('Error loading loan details:', error);
                content.innerHTML = '<div class="alert alert-error">Error loading loan details</div>';
            }
        }
        
        // Function to refresh loan details in modal if open
        async function refreshLoanDetailsIfOpen() {
            const modal = document.getElementById('loanDetailsModal');
            if (modal && modal.classList.contains('active') && currentLoanDetailsId) {
                await viewLoanDetails(currentLoanDetailsId);
            }
        }
        
        function generateLoanDetailsHTML(loan) {
            return `
                <div class="loan-details-grid">
                    <div class="detail-section">
                        <h3>Loan Information</h3>
                        <div class="detail-item">
                            <strong>Serial Number:</strong>
                            <span>${loan.serial_number}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Loan ID:</strong>
                            <span>${loan.id}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Company:</strong>
                            <span>${loan.company_name}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Loan Date:</strong>
                            <span>${formatDate(loan.loan_date)}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Status:</strong>
                            <span class="status ${loan.status === 'delivered' ? 'released' : loan.status === 'defaulted' ? 'unredeemed' : loan.status}">${formatStatus(loan.status)}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Released Date:</strong>
                            <span>${(loan.released_date || loan.releasedDate || loan.delivered_date || loan.deliveredDate) ? formatDate(loan.released_date || loan.releasedDate || loan.delivered_date || loan.deliveredDate) : 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Loan Amount & Item</h3>
                        <div class="detail-item">
                            <strong>Loan Amount:</strong>
                            <span>‚Çπ${parseFloat(loan.loan_amount).toFixed(2)}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Item Type:</strong>
                            <span>${loan.item_type.toUpperCase()}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Item Weight:</strong>
                            <span>${parseFloat(loan.item_weight).toFixed(3)} grams</span>
                        </div>
                        <div class="detail-item">
                            <strong>Item Description:</strong>
                            <span>${loan.item_description}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Customer Information</h3>
                        <div class="detail-item">
                            <strong>Name:</strong>
                            <span>${loan.customer_name}</span>
                        </div>
                        ${loan.father_name ? `
                        <div class="detail-item">
                            <strong>Father's Name:</strong>
                            <span>${loan.father_name}</span>
                        </div>
                        ` : ''}
                        ${loan.husband_name ? `
                        <div class="detail-item">
                            <strong>Husband's Name:</strong>
                            <span>${loan.husband_name}</span>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <strong>Address:</strong>
                            <span>${loan.address}</span>
                        </div>
                        ${loan.occupation ? `
                        <div class="detail-item">
                            <strong>Occupation:</strong>
                            <span>${loan.occupation}</span>
                        </div>
                        ` : ''}
                        ${loan.cell_number ? `
                        <div class="detail-item">
                            <strong>Contact:</strong>
                            <span>${loan.cell_number}</span>
                        </div>
                        ` : ''}
                        <div class="detail-item">
                            <strong>Aadhar Number:</strong>
                            <span>${loan.aadhar_number || loan.aadharNumber || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateLoanButtonsHTML(loan) {
            const status = (loan.status || 'active').toLowerCase();
            const isActive = status === 'active';
            const isReleased = status === 'released' || status === 'delivered';
            const isUnredeemed = status === 'unredeemed' || status === 'defaulted';
            
            return `
                <button onclick="generateMailingLabel(${loan.id})" class="btn btn-secondary">Generate Mailing Label</button>
                ${isActive ? `
                <button onclick="deliverLoan(${loan.id})" class="btn btn-success">Mark as Released</button>
                <button onclick="defaultLoan(${loan.id}); closeLoanDetails();" class="btn btn-danger">Mark as Unredeemed</button>
                ` : ''}
                ${!isActive ? `
                <button onclick="undoLoanAction(${loan.id})" class="btn btn-warning">Undo Action</button>
                ` : ''}
                <button onclick="deleteLoan(${loan.id})" class="btn btn-danger">Delete Permanently</button>
            `;
        }

        async function deleteLoan(loanId) {
            if (!confirm('This action will permanently delete the loan record. This cannot be undone. Continue?')) {
                return;
            }

            try {
                const response = await authFetch(`/api/loans/${loanId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Loan deleted permanently', 'success');
                    closeLoanDetails();
                    loadLoans();
                    loadDashboard();
                } else {
                    showAlert(data.error || 'Error deleting loan', 'error');
                }
            } catch (error) {
                console.error('Error deleting loan:', error);
                showAlert('Error deleting loan', 'error');
            }
        }
        
        function closeLoanDetails() {
            const modal = document.getElementById('loanDetailsModal');
            const footer = document.getElementById('loanDetailsFooter');
            modal.classList.remove('active');
            footer.style.display = 'none';
            currentLoanDetailsId = null; // Clear stored loan ID
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('loanDetailsModal');
            if (event.target === modal) {
                closeLoanDetails();
            }
        }
    </script>
</body>
</html>
